<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Nueva Factura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-header {
            @apply bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
        }
        .table-cell {
            @apply px-4 py-3 whitespace-nowrap text-sm text-gray-700;
        }
        /* Estilo para el estado de carga del botón */
        .btn-loading {
            @apply relative cursor-not-allowed;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 24px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

<div class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="p-6 sm:p-8 border-b border-gray-200">
            <h1 class="text-2xl font-bold text-gray-900">Crear Nueva Factura</h1>
            <p class="mt-1 text-sm text-gray-500">Completa los datos para generar un nuevo comprobante de pago.</p>
        </div>

        <form id="invoiceForm" class="p-6 sm:p-8 space-y-8">
            <!-- Sección de Datos del Cliente -->
            <div class="space-y-6">
                <h2 class="text-lg font-semibold text-gray-800 border-b pb-2">Datos del Cliente</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="customerName" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                        <input type="text" id="customerName" name="customerName" placeholder="Ej: Carlos Andrés Zuluaga" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="customerID" class="block text-sm font-medium text-gray-700">Número de Identificación (Cédula/NIT)</label>
                        <input type="text" id="customerID" name="customerID" placeholder="Ej: 1234567890" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="customerAddress" class="block text-sm font-medium text-gray-700">Dirección</label>
                        <input type="text" id="customerAddress" name="customerAddress" placeholder="Ej: Calle 10 # 43A-20, Medellín" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="customerPhone" class="block text-sm font-medium text-gray-700">Teléfono</label>
                        <input type="tel" id="customerPhone" name="customerPhone" placeholder="Ej: 3001234567" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div class="md:col-span-2">
                        <label for="customerEmail" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                        <input type="email" id="customerEmail" name="customerEmail" placeholder="ejemplo@correo.com" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
            </div>

            <!-- Sección de Items de la Factura -->
            <div class="space-y-6">
                <h2 class="text-lg font-semibold text-gray-800 border-b pb-2">Detalles de la Compra</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="table-header">
                        <tr>
                            <th scope="col" class="px-4 py-3">Descripción</th>
                            <th scope="col" class="px-4 py-3 w-24">Cantidad</th>
                            <th scope="col" class="px-4 py-3 w-36">Precio Unitario</th>
                            <th scope="col" class="px-4 py-3 w-36">Total</th>
                            <th scope="col" class="relative px-4 py-3 w-12"><span class="sr-only">Eliminar</span></th>
                        </tr>
                        </thead>
                        <tbody id="invoiceItems" class="bg-white divide-y divide-gray-200">
                        <!-- Las filas se agregarán aquí con JS -->
                        </tbody>
                    </table>
                </div>
                <button type="button" id="addItemBtn" class="w-full sm:w-auto flex items-center justify-center px-4 py-2 border border-dashed border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                    Agregar Producto o Servicio
                </button>
            </div>

            <!-- Sección de Totales y Pago -->
            <div class="space-y-6">
                <div class="flex justify-end">
                    <div class="w-full max-w-sm space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-500">Subtotal:</span>
                            <span id="subtotal" class="text-sm text-gray-900" data-raw-value="0">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-500">IVA (19%):</span>
                            <span id="tax" class="text-sm text-gray-900" data-raw-value="0">$0.00</span>
                        </div>
                        <div class="flex justify-between border-t pt-3">
                            <span class="text-base font-semibold text-gray-900">Total a Pagar:</span>
                            <span id="grandTotal" class="text-base font-semibold text-gray-900" data-raw-value="0">$0.00</span>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="paymentMethod" class="block text-sm font-medium text-gray-700">Medio de Pago</label>
                    <select id="paymentMethod" name="paymentMethod" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option>Efectivo</option>
                        <option>Tarjeta de Crédito</option>
                        <option>Transferencia Bancaria</option>
                        <option>Nequi / Daviplata</option>
                    </select>
                </div>
            </div>

        </form>

        <div class="p-6 sm:p-8 bg-gray-50">
            <div class="flex justify-end">
                <button type="submit" form="invoiceForm" id="generateBtn" class="px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Generar Factura PDF
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const itemsContainer = document.getElementById('invoiceItems');
        const addItemBtn = document.getElementById('addItemBtn');
        const invoiceForm = document.getElementById('invoiceForm');
        const generateBtn = document.getElementById('generateBtn');

        const subtotalEl = document.getElementById('subtotal');
        const taxEl = document.getElementById('tax');
        const grandTotalEl = document.getElementById('grandTotal');

        let itemId = 0;

        function createItemRow() {
            itemId++;
            const row = document.createElement('tr');
            row.id = `item-row-${itemId}`;
            row.innerHTML = `
                <td class="table-cell">
                    <input type="text" placeholder="Descripción del item" class="w-full border-gray-300 rounded-md shadow-sm sm:text-sm description" required>
                </td>
                <td class="table-cell">
                    <input type="number" value="1" min="1" class="w-full border-gray-300 rounded-md shadow-sm sm:text-sm quantity">
                </td>
                <td class="table-cell">
                    <input type="number" placeholder="0.00" min="0" step="0.01" class="w-full border-gray-300 rounded-md shadow-sm sm:text-sm unit-price">
                </td>
                <td class="table-cell">
                    <span class="total-price font-medium text-gray-800" data-raw-value="0">$0.00</span>
                </td>
                <td class="table-cell text-center">
                    <button type="button" class="text-red-600 hover:text-red-800 remove-item-btn">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </td>
            `;
            itemsContainer.appendChild(row);
        }

        function updateTotals() {
            let subtotal = 0;
            itemsContainer.querySelectorAll('tr').forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
                const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
                const totalPrice = quantity * unitPrice;
                const totalPriceEl = row.querySelector('.total-price');
                totalPriceEl.textContent = formatCurrency(totalPrice);
                totalPriceEl.dataset.rawValue = totalPrice;
                subtotal += totalPrice;
            });

            const tax = subtotal * 0.19;
            const grandTotal = subtotal + tax;

            subtotalEl.textContent = formatCurrency(subtotal);
            subtotalEl.dataset.rawValue = subtotal;
            taxEl.textContent = formatCurrency(tax);
            taxEl.dataset.rawValue = tax;
            grandTotalEl.textContent = formatCurrency(grandTotal);
            grandTotalEl.dataset.rawValue = grandTotal;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(amount);
        }

        addItemBtn.addEventListener('click', createItemRow);

        itemsContainer.addEventListener('click', function (e) {
            if (e.target.closest('.remove-item-btn')) {
                e.target.closest('tr').remove();
                updateTotals();
            }
        });

        itemsContainer.addEventListener('input', function (e) {
            if (e.target.classList.contains('quantity') || e.target.classList.contains('unit-price')) {
                updateTotals();
            }
        });

        createItemRow();

        invoiceForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            generateBtn.disabled = true;
            generateBtn.classList.add('btn-loading');
            generateBtn.textContent = 'Generando...';

            const customerData = {
                customerName: document.getElementById('customerName').value,
                customerID: document.getElementById('customerID').value,
                customerAddress: document.getElementById('customerAddress').value,
                customerPhone: document.getElementById('customerPhone').value,
                customerEmail: document.getElementById('customerEmail').value
            };

            const items = [];
            itemsContainer.querySelectorAll('tr').forEach(row => {
                items.push({
                    description: row.querySelector('.description').value,
                    quantity: parseInt(row.querySelector('.quantity').value, 10),
                    unitPrice: parseFloat(row.querySelector('.unit-price').value),
                    total: parseFloat(row.querySelector('.total-price').dataset.rawValue)
                });
            });

            const totalsData = {
                subtotal: parseFloat(subtotalEl.dataset.rawValue),
                tax: parseFloat(taxEl.dataset.rawValue),
                grandTotal: parseFloat(grandTotalEl.dataset.rawValue)
            };

            const fullInvoiceData = {
                customer: customerData,
                items: items,
                totals: totalsData,
                paymentMethod: document.getElementById('paymentMethod').value
            };

            console.log('Enviando datos al backend:', JSON.stringify(fullInvoiceData, null, 2));

            try {
                const response = await fetch('http://localhost:8080/api/invoices/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(fullInvoiceData),
                });

                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'factura.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

            } catch (error) {
                console.error('Error al generar la factura:', error);
                alert('No se pudo generar la factura. Revisa la consola para más detalles.');
            } finally {
                generateBtn.disabled = false;
                generateBtn.classList.remove('btn-loading');
                generateBtn.textContent = 'Generar Factura PDF';
            }
        });
    });
</script>
</body>
</html>
